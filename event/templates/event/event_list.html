{% extends 'base.html' %}
{% load static %}

{% block title %}Community Events | GetFit.Today{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto text-white px-4">
  <h1 class="text-3xl font-bold mb-6 text-yellow-400 text-center">Community Events</h1>

  <div class="bg-blue-900 rounded-2xl px-6 py-4 mb-6 border border-blue-700">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
      <!-- Left: View Toggle Buttons -->
      <div class="flex justify-center sm:justify-start items-center space-x-3">
        <a href="{% url 'event_list' %}" 
          class="inline-flex items-center justify-center px-5 py-2.5 rounded-lg font-semibold transition
          {% if not request.GET.my_events %}
            bg-yellow-400 text-blue-900
          {% else %}
            bg-blue-700 text-white hover:bg-blue-600
          {% endif %}">
          Semua Event
        </a>

        {% if user.is_authenticated %}
          <a href="?my_events=true" 
            class="inline-flex items-center justify-center px-5 py-2.5 rounded-lg font-semibold transition
            {% if request.GET.my_events %}
              bg-yellow-400 text-blue-900
            {% else %}
              bg-blue-700 text-white hover:bg-blue-600
            {% endif %}">
            Event yang Saya Kelola
          </a>
        {% endif %}
      </div>

      <!-- Right: Create Button -->
      {% if user.is_authenticated and user_admin_communities %}
        <div class="flex justify-center sm:justify-end">
          <button id="createBtn" 
            class="inline-flex items-center justify-center px-6 py-2.5 bg-yellow-400 text-blue-900 font-bold rounded-lg hover:bg-yellow-300 shadow-md transition">
            + Buat Event Baru
          </button>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Filter Panel -->
  <div class="bg-blue-900p-4 mb-6">
    <div class="flex items-center justify-between cursor-pointer" id="filterToggle">
      <div class="flex items-center space-x-2">
        <span class="text-lg font-semibold text-yellow-300">▼ Filter Panel</span>
      </div>
    </div>

    <!-- Filter Form (Collapsed by default) -->
    <div id="filterPanel" class="hidden mt-4 space-y-3 border-t border-blue-700 pt-4">
      <form id="filterForm" method="GET" action="{% url 'event_list' %}" class="space-y-3">
        <!-- Preserve my_events parameter if exists -->
        {% if request.GET.my_events %}
          <input type="hidden" name="my_events" value="true">
        {% endif %}
        
        <!-- Nama Event -->
        <div>
          <label class="flex items-center space-x-2 text-sm text-gray-300 mb-1">
            <span class="text-blue-400">🔵</span>
            <span>Nama Event: </span>
          </label>
          <input type="text" name="name" id="filter_name" 
                 placeholder="Cari nama event..." 
                 value="{{ filter_name }}"
                 class="w-full px-3 py-2 rounded-lg text-black bg-gray-100">
        </div>

        <!-- Lokasi -->
        <div>
          <label class="flex items-center space-x-2 text-sm text-gray-300 mb-1">
            <span class="text-pink-400">📍</span>
            <span>Lokasi: </span>
          </label>
          <input type="text" name="location" id="filter_location" 
                 placeholder="Masukkan lokasi..." 
                 value="{{ filter_location }}"
                 class="w-full px-3 py-2 rounded-lg text-black bg-gray-100">
        </div>

        <!-- Tanggal -->
        <div>
          <label class="flex items-center space-x-2 text-sm text-gray-300 mb-1">
            <span class="text-purple-400">📅</span>
            <span>Tanggal: </span>
          </label>
          <select name="date_sort" id="filter_date_sort" 
                  class="w-full px-3 py-2 rounded-lg text-black bg-gray-100">
            <option value="newest" {% if filter_date_sort == 'newest' %}selected{% endif %}>Terbaru Ditambahkan</option>
            <option value="soonest" {% if filter_date_sort == 'soonest' %}selected{% endif %}>Dari Tercepat</option>
            <option value="latest" {% if filter_date_sort == 'latest' %}selected{% endif %}>Dari Terlambat</option>
          </select>
        </div>

        <!-- Komunitas -->
        <div>
          <label class="flex items-center space-x-2 text-sm text-gray-300 mb-1">
            <span class="text-yellow-400">✏️</span>
            <span>Komunitas: </span>
          </label>
          <input type="text" name="community" id="filter_community" 
                 list="communityList"
                 placeholder="Cari komunitas..." 
                 value="{{ filter_community }}"
                 class="w-full px-3 py-2 rounded-lg text-black bg-gray-100">
          <datalist id="communityList">
            {% for comm in all_communities %}
              <option value="{{ comm.name }}">
            {% endfor %}
          </datalist>
        </div>

        <!-- Status Event -->
        <div>
          <label class="flex items-center space-x-2 text-sm text-gray-300 mb-1">
            <span class="text-green-400">⏰</span>
            <span>Status Event: </span>
          </label>
          <select name="status" id="filter_status" 
                  class="w-full px-3 py-2 rounded-lg text-black bg-gray-100">
            <option value="all" {% if filter_status == 'all' %}selected{% endif %}>Semua Event</option>
            <option value="upcoming" {% if filter_status == 'upcoming' %}selected{% endif %}>Event yang Belum Berjalan</option>
            <option value="past" {% if filter_status == 'past' %}selected{% endif %}>Event yang Sudah Lewat</option>
          </select>
        </div>

        <!-- Buttons -->
        <div class="flex space-x-3 pt-2">
          <button type="button" id="resetFilter" 
                  class="flex-1 px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 transition">
             Reset 
          </button>
          <button type="submit" 
                  class="flex-1 px-4 py-2 rounded-lg bg-yellow-400 text-blue-900 font-semibold hover:bg-yellow-300 transition">
             Terapkan Filter 
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Event List / Empty State -->
  {% if not events %}
    <div class="flex flex-col items-center justify-center mt-12 mb-8">
      <!-- No Events Image -->
      <img src="{% static 'event/image/no-events.png' %}" 
           alt="No Events" 
           class="w-64 h-64 object-contain mb-6 opacity-80">
      
      <!-- Message -->
      <p class="text-center text-gray-300 text-lg">
        {% if request.GET.my_events %}
          Kamu belum mengelola event apapun.
        {% else %}
          Tidak ada event yang sesuai dengan filter.
        {% endif %}
      </p>
    </div>
  {% endif %}

  <div id="eventList" class="space-y-6 mt-8">
    {% for event in events %}
      <div id="event-{{ event.id }}" class="bg-blue-800 p-6 rounded-lg shadow-md border border-blue-700">
        <h3 class="text-xl font-semibold text-yellow-300">{{ event.name }}</h3>
        <p class="mt-2 text-gray-200">{{ event.description }}</p>
        <p class="mt-1 text-sm text-gray-400">
          📅 {{ event.date }} &nbsp;&nbsp;📍 {{ event.location }}
        </p>
        <p class="mt-1 text-sm font-semibold text-white">
          Komunitas: {{ event.community_name }}
        </p>
        <p class="mt-1 text-sm text-gray-400">
          👥 {{ event.participant_count }} peserta terdaftar
        </p>

        <div class="mt-4 flex justify-between items-center">
          <div class="flex space-x-3">
            {% if user.is_authenticated and event.can_edit %}
              <button class="edit-btn bg-yellow-400 text-blue-900 font-semibold px-4 py-1 rounded-lg hover:bg-yellow-300 transition"
                data-id="{{ event.id }}"
                data-name="{{ event.name }}"
                data-desc="{{ event.description }}"
                data-date="{{ event.date_input }}"
                data-loc="{{ event.location }}"
                data-community="{{ event.community_id }}">
                Edit
              </button>
            {% endif %}
          </div>

          <div class="text-right">
            {% if user.is_authenticated %}
              {% if event.can_join %}
                <button class="join-btn bg-green-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-green-400 transition"
                  data-id="{{ event.id }}">
                  Join Event
                </button>
              
              {% elif event.is_participant %}
                <button class="leave-btn bg-orange-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-orange-400 transition"
                  data-id="{{ event.id }}"
                  data-name="{{ event.name }}">
                  Leave Event
                </button>
              
              {% elif not event.registration_open %}
                <button class="bg-gray-500 text-gray-300 font-semibold px-6 py-2 rounded-lg cursor-not-allowed" disabled>
                  Join Event
                </button>
                <p class="text-xs text-red-400 mt-1">Masa pendaftaran sudah ditutup</p>
              {% endif %}
            
            {% else %}
              <p class="text-sm text-gray-300 italic">Login untuk bergabung dengan event ini.</p>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Modal Create/Edit Event -->
<div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 px-4">
  <div class="bg-blue-900 rounded-2xl p-6 w-full max-w-md">
    <h2 id="modalTitle" class="text-2xl font-bold text-yellow-300 mb-4">Buat Event</h2>
    <form id="eventForm" class="space-y-3">
      <input type="hidden" id="event_id" name="event_id" value="">
      
      <div>
        <label class="block text-sm text-gray-300 mb-1">Nama Event</label>
        <input type="text" id="event_name" name="name" placeholder="Nama event" required 
               class="w-full px-3 py-2 rounded-lg text-black">
      </div>

      <div>
        <label class="block text-sm text-gray-300 mb-1">Komunitas</label>
        <select id="event_community" name="community" required 
                class="w-full px-3 py-2 rounded-lg text-black">
          <option value="">-- Pilih Komunitas --</option>
          {% for comm in user_admin_communities %}
            <option value="{{ comm.id }}">{{ comm.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm text-gray-300 mb-1">Tanggal & Waktu</label>
        <input type="datetime-local" id="event_date" name="date" required 
               class="w-full px-3 py-2 rounded-lg text-black">
      </div>

      <div>
        <label class="block text-sm text-gray-300 mb-1">Lokasi</label>
        <input type="text" id="event_location" name="location" placeholder="Lokasi" required 
               class="w-full px-3 py-2 rounded-lg text-black">
      </div>

      <div>
        <label class="block text-sm text-gray-300 mb-1">Deskripsi</label>
        <textarea id="event_description" name="description" placeholder="Deskripsi" required 
                  class="w-full px-3 py-2 rounded-lg text-black" rows="4"></textarea>
      </div>

      <!-- Buttons: Delete (left) | Batal Update (right) -->
      <div class="flex justify-between items-center pt-2">
        <!-- Delete Button (only show in edit mode) -->
        <button type="button" id="deleteBtn" 
                class="hidden px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-400 transition">
          Hapus Event
        </button>
        
        <!-- Spacer for create mode -->
        <div id="deleteSpacer"></div>

        <!-- Right side buttons -->
        <div class="flex space-x-3">
          <button type="button" id="closeModal" 
                  class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-500 transition">
            Batal
          </button>
          <button type="submit" id="saveBtn" 
                  class="px-4 py-2 bg-yellow-400 text-blue-900 font-semibold rounded-lg hover:bg-yellow-300 transition">
            Simpan
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Confirmation Modal for Delete -->
<div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] px-4">
  <div class="bg-blue-900 rounded-2xl p-6 w-full max-w-sm border-2 border-red-500">
    <h3 class="text-xl font-bold text-red-400 mb-3">Konfirmasi Hapus</h3>
    <p class="text-gray-200 mb-6">Yakin ingin menghapus event "<span id="deleteEventName" class="font-semibold text-yellow-300"></span>"?</p>
    
    <div class="flex space-x-3">
      <button type="button" id="cancelDelete" 
              class="flex-1 px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-500 transition">
        Batal
      </button>
      <button type="button" id="confirmDelete" 
              class="flex-1 px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-400 transition">
        Hapus
      </button>
    </div>
  </div>
</div>

<div id="toastContainer" class="fixed bottom-8 right-8 z-50 space-y-3"></div>
{% endblock %}

{% block extra_js %}
<script>
  // Filter Panel Toggle
  const filterToggle = document.getElementById('filterToggle');
  const filterPanel = document.getElementById('filterPanel');
  let isFilterOpen = false;

  filterToggle.addEventListener('click', () => {
    isFilterOpen = !isFilterOpen;
    if (isFilterOpen) {
      filterPanel.classList.remove('hidden');
      filterToggle.querySelector('span').textContent = '▲ Filter Panel';
    } else {
      filterPanel.classList.add('hidden');
      filterToggle.querySelector('span').textContent = '▼ Filter Panel';
    }
  });

  // Reset Filter
  const resetFilter = document.getElementById('resetFilter');
  resetFilter.addEventListener('click', () => {
    const myEvents = new URLSearchParams(window.location.search).get('my_events');
    if (myEvents) {
      window.location.href = '{% url "event_list" %}?my_events=true';
    } else {
      window.location.href = '{% url "event_list" %}';
    }
  });

  // Modal & CRUD Operations
  const createBtn = document.getElementById('createBtn');
  const eventModal = document.getElementById('eventModal');
  const closeModal = document.getElementById('closeModal');
  const eventForm = document.getElementById('eventForm');
  const modalTitle = document.getElementById('modalTitle');
  const saveBtn = document.getElementById('saveBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const deleteSpacer = document.getElementById('deleteSpacer');
  
  // Delete confirmation modal
  const deleteConfirmModal = document.getElementById('deleteConfirmModal');
  const deleteEventName = document.getElementById('deleteEventName');
  const cancelDelete = document.getElementById('cancelDelete');
  const confirmDelete = document.getElementById('confirmDelete');
  let currentDeleteId = null;

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `transform transition-all duration-300 ease-in-out max-w-sm`;

    let icon, bgColor, borderColor;
    if (type === 'success') {
      icon = '✓';
      bgColor = 'bg-green-500';
      borderColor = 'border-green-600';
    } else {
      icon = '✗';
      bgColor = 'bg-red-500';
      borderColor = 'border-red-600';
    }
    
    toast.innerHTML = `
      <div class="${bgColor} ${borderColor} border-l-4 text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3">
        <span class="text-2xl font-bold">${icon}</span>
        <span class="flex-1">${message}</span>
        <button class="text-white hover:text-gray-200 font-bold text-xl" onclick="this.parentElement.parentElement.remove()">×</button>
      </div>
    `;

    toastContainer.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateX(0)';
    }, 10);

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }

  // Create Event
  if (createBtn) {
    createBtn.addEventListener('click', () => {
      modalTitle.textContent = 'Buat Event';
      eventForm.reset();
      document.getElementById('event_id').value = '';
      document.getElementById('event_community').disabled = false;
      saveBtn.textContent = 'Simpan';
      deleteBtn.classList.add('hidden');
      deleteSpacer.style.display = 'block';
      eventModal.classList.remove('hidden');
    });
  }

  closeModal.addEventListener('click', () => {
    eventModal.classList.add('hidden');
  });

  eventModal.addEventListener('click', (e) => {
    if (e.target === eventModal) {
      eventModal.classList.add('hidden');
    }
  });

  // Submit Form (Create/Edit)
  eventForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const eventId = document.getElementById('event_id').value;
    const isEdit = !!eventId;
    const url = isEdit ? `/event/edit/${eventId}/` : `/event/create/`;

    const formData = {
      name: document.getElementById('event_name').value,
      description: document.getElementById('event_description').value,
      date: document.getElementById('event_date').value,
      location: document.getElementById('event_location').value,
      community: document.getElementById('event_community').value,
    };

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify(formData),
      });

      const result = await response.json();
      
      if (response.ok && result.status === 'success') {
        showToast(result.message, 'success');
        eventModal.classList.add('hidden');
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(result.message || 'Terjadi kesalahan', 'error');
      }
    } catch (error) {
      showToast('Gagal menghubungi server', 'error');
      console.error('Error:', error);
    }
  });

  // Edit Event
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      modalTitle.textContent = 'Edit Event';
      saveBtn.textContent = 'Update';
      
      const eventId = btn.dataset.id;
      document.getElementById('event_id').value = eventId;
      document.getElementById('event_name').value = btn.dataset.name;
      document.getElementById('event_description').value = btn.dataset.desc;
      document.getElementById('event_location').value = btn.dataset.loc;
      document.getElementById('event_community').value = btn.dataset.community;
      document.getElementById('event_community').disabled = true;
      document.getElementById('event_date').value = btn.dataset.date;
      
      // Show delete button and hide spacer
      deleteBtn.classList.remove('hidden');
      deleteSpacer.style.display = 'none';
      
      // Store event name for delete confirmation
      deleteBtn.dataset.name = btn.dataset.name;
      deleteBtn.dataset.id = eventId;
      
      eventModal.classList.remove('hidden');
    });
  });

  // Delete Button Click (show confirmation modal)
  deleteBtn.addEventListener('click', () => {
    const eventName = deleteBtn.dataset.name;
    const eventId = deleteBtn.dataset.id;
    
    deleteEventName.textContent = eventName;
    currentDeleteId = eventId;
    
    deleteConfirmModal.classList.remove('hidden');
  });

  // Cancel Delete
  cancelDelete.addEventListener('click', () => {
    deleteConfirmModal.classList.add('hidden');
    currentDeleteId = null;
  });

  // Confirm Delete
  confirmDelete.addEventListener('click', async () => {
    if (!currentDeleteId) return;

    try {
      const response = await fetch(`/event/delete/${currentDeleteId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        },
      });

      const result = await response.json();
      
      if (response.ok && result.status === 'success') {
        showToast(result.message, 'success');
        deleteConfirmModal.classList.add('hidden');
        eventModal.classList.add('hidden');
        
        const eventElement = document.getElementById(`event-${currentDeleteId}`);
        if (eventElement) {
          eventElement.style.transition = 'opacity 0.3s';
          eventElement.style.opacity = '0';
          setTimeout(() => eventElement.remove(), 300);
        }
        
        currentDeleteId = null;
      } else {
        showToast(result.message || 'Gagal menghapus event', 'error');
      }
    } catch (error) {
      showToast('Gagal menghubungi server', 'error');
      console.error('Error:', error);
    }
  });

  // Join Event
  document.querySelectorAll('.join-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      try {
        const response = await fetch(`/event/join/${btn.dataset.id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
          },
        });

        const result = await response.json();
        
        if (response.ok && result.status === 'success') {
          showToast(result.message, 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(result.message || 'Gagal bergabung ke event', 'error');
        }
      } catch (error) {
        showToast('Gagal menghubungi server', 'error');
        console.error('Error:', error);
      }
    });
  });

  // Leave Event (NEW: Custom confirmation modal with AJAX)
  document.querySelectorAll('.leave-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const eventName = btn.dataset.name;
      
      // Create custom confirmation modal
      const confirmLeave = document.createElement('div');
      confirmLeave.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] px-4';
      confirmLeave.innerHTML = `
        <div class="bg-blue-900 rounded-2xl p-6 w-full max-w-sm border-2 border-orange-500">
          <h3 class="text-xl font-bold text-orange-400 mb-3">Konfirmasi Keluar</h3>
          <p class="text-gray-200 mb-6">Yakin ingin keluar dari event "<span class="font-semibold text-yellow-300">${eventName}</span>"?</p>
          
          <div class="flex space-x-3">
            <button type="button" class="cancel-leave flex-1 px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-500 transition">
              Batal
            </button>
            <button type="button" class="confirm-leave flex-1 px-4 py-2 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-400 transition">
              Keluar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmLeave);
      
      // Cancel button
      confirmLeave.querySelector('.cancel-leave').addEventListener('click', () => {
        confirmLeave.remove();
      });
      
      // Confirm button
      confirmLeave.querySelector('.confirm-leave').addEventListener('click', async () => {
        try {
          const response = await fetch(`/event/leave/${btn.dataset.id}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
            },
          });

          const result = await response.json();
          
          if (response.ok && result.status === 'success') {
            showToast(result.message, 'success');
            confirmLeave.remove();
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast(result.message || 'Gagal keluar dari event', 'error');
            confirmLeave.remove();
          }
        } catch (error) {
          showToast('Gagal menghubungi server', 'error');
          console.error('Error:', error);
          confirmLeave.remove();
        }
      });
    });
  });
</script>
{% endblock %}