{% extends 'base.html' %}
{% load static %}

{% block title %}Detail {{ community.name }}{% endblock %}

{% block body_class %}home-theme font-sans text-[#1B2B5A]{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-10 px-6">

    <div class="grid grid-cols-1 md:grid-cols-3 items-center mb-8 gap-4">
        
        <div class="text-left order-1">
            <a href="{% url 'community_list' %}" class="inline-flex items-center gap-2 px-5 py-2.5 bg-[#0E5A64] text-white font-semibold rounded-xl shadow-sm hover:bg-[#0b464e] transition-all group w-fit">
                <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                Back to List
            </a>
        </div>

        <div class="text-center order-2">
            <h1 class="text-3xl md:text-4xl font-extrabold text-[#1B2B5A] drop-shadow-sm">
                Detail Community
            </h1>
        </div>

        <div class="hidden md:block order-3"></div>
    </div>

    <div class="bg-white rounded-[2.5rem] shadow-[0_20px_50px_rgba(14,90,100,0.15)] overflow-hidden border border-[#C8DDF6]">
        
        <div class="relative h-64 md:h-80 w-full bg-gray-800 group">
            {% if community.image %}
                <img src="{{ community.image.url }}" class="w-full h-full object-cover opacity-90 group-hover:scale-105 transition-transform duration-700" alt="Cover">
            {% else %}
                <img src="https://images.unsplash.com/photo-1571902943202-507ec2618e8f?auto=format&fit=crop&w=1600&q=80" class="w-full h-full object-cover opacity-80" alt="Default">
            {% endif %}
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
        </div>

        <div class="px-8 pb-10">
            
            <div class="flex flex-col md:flex-row items-center md:items-end gap-6 -mt-12 md:-mt-16 mb-8 relative z-10">
                
                <div class="flex-shrink-0">
                    <div class="w-32 h-32 md:w-40 md:h-40 rounded-full bg-white p-2 shadow-2xl">
                        {% if community.image %}
                            <img src="{{ community.image.url }}" class="w-full h-full rounded-full object-cover bg-gray-100">
                        {% else %}
                            <div class="w-full h-full rounded-full bg-gray-100 flex items-center justify-center text-gray-400">
                                <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="text-center md:text-left flex-grow pb-2">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-[#1B2B5A]">{{ community.name }}</h2>
                    <p class="text-[#6B7A99] font-medium text-lg mt-1">
                        {% if community.short_description %}{{ community.short_description }}{% else %}{{ community.category }} Community{% endif %}
                    </p>
                </div>

                <div class="flex-shrink-0 pb-2 w-full md:w-auto" data-community-id="{{ community.id }}">
                    {% if request.user in community.admins.all %}
                        <button disabled class="w-full md:w-auto px-8 py-3 rounded-xl bg-gray-100 text-gray-400 font-bold border border-gray-200 cursor-default">
                            Administrator
                        </button>
                    {% elif request.user in community.members.all %}
                        <div class="flex gap-3">
                            <button id="leave-btn" class="flex-1 md:flex-none px-8 py-3 rounded-xl bg-red-50 text-red-600 font-bold border border-red-200 hover:bg-red-100 transition-colors">
                                Leave
                            </button>
                            <button id="join-btn" class="hidden flex-1 md:flex-none px-8 py-3 rounded-xl bg-[#0E5A64] text-white font-bold hover:bg-[#0b464e] shadow-lg transition-all">
                                Join Now
                            </button>
                        </div>
                    {% else %}
                        <div class="flex gap-3">
                            <button id="leave-btn" class="hidden flex-1 md:flex-none px-8 py-3 rounded-xl bg-red-50 text-red-600 font-bold border border-red-200 hover:bg-red-100 transition-colors">
                                Leave
                            </button>
                            <button id="join-btn" class="flex-1 md:flex-none px-8 py-3 rounded-xl bg-[#0E5A64] text-white font-bold hover:bg-[#0b464e] shadow-lg transition-all">
                                Join Now
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <a href="{% url 'event:event_list' %}?community={{ community.name|urlencode }}&from_community={{ community.id }}" 
               class="block w-full py-4 rounded-2xl border-2 border-dashed border-[#0E5A64]/30 bg-[#F0FDF4] text-[#0E5A64] font-bold text-center hover:bg-[#0E5A64] hover:text-white hover:border-transparent transition-all mb-10">
               ðŸ“… See Upcoming Events
            </a>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                
                <div class="lg:col-span-3">
                    <div class="flex gap-8 border-b-2 border-gray-100 mb-8 overflow-x-auto">
                        <button onclick="switchTab('about')" id="btn-about" class="tab-btn active pb-4 px-2 text-lg font-bold text-[#0E5A64] border-b-[3px] border-[#0E5A64] transition-all whitespace-nowrap">About</button>
                        <button onclick="switchTab('schedule')" id="btn-schedule" class="tab-btn pb-4 px-2 text-lg font-bold text-gray-400 hover:text-gray-600 border-b-[3px] border-transparent transition-all whitespace-nowrap">Schedule</button>
                        <button onclick="switchTab('members')" id="btn-members" class="tab-btn pb-4 px-2 text-lg font-bold text-gray-400 hover:text-gray-600 border-b-[3px] border-transparent transition-all whitespace-nowrap">Members</button>
                    </div>

                    <div id="tab-about" class="tab-content block animate-fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="md:col-span-2">
                                <h3 class="text-xl font-bold text-[#1B2B5A] mb-4">Description</h3>
                                <div class="prose max-w-none text-[#0B3440] leading-relaxed bg-[#F8FBFF] p-6 rounded-2xl border border-[#C8DDF6]">
                                    {{ community.description|linebreaksbr }}
                                </div>
                            </div>
                            
                            <div class="md:col-span-1 space-y-4">
                                <div class="bg-[#F8FBFF] p-5 rounded-2xl border border-[#C8DDF6]">
                                    <p class="text-xs uppercase font-bold text-[#6B7A99] mb-1">Sport Type</p>
                                    <p class="font-bold text-[#1B2B5A] text-lg flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-[#0E5A64]"></span> {{ community.category }}
                                    </p>
                                </div>
                                <div class="bg-[#F8FBFF] p-5 rounded-2xl border border-[#C8DDF6]">
                                    <p class="text-xs uppercase font-bold text-[#6B7A99] mb-1">Location</p>
                                    <p class="font-bold text-[#1B2B5A] text-lg truncate">
                                        {% if community.fitness_spot %}{{ community.fitness_spot.name }}{% else %}Online{% endif %}
                                    </p>
                                </div>
                                <div class="bg-[#F8FBFF] p-5 rounded-2xl border border-[#C8DDF6]">
                                    <p class="text-xs uppercase font-bold text-[#6B7A99] mb-1">Established</p>
                                    <p class="font-bold text-[#1B2B5A] text-lg">{{ community.created_at|date:"F Y" }}</p>
                                </div>
                                <div class="bg-[#F8FBFF] p-5 rounded-2xl border border-[#C8DDF6]">
                                    <p class="text-xs uppercase font-bold text-[#6B7A99] mb-1">Contact</p>
                                    <p class="font-bold text-[#1B2B5A] text-lg">{{ community.contact_info }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-schedule" class="tab-content hidden animate-fade-in">
                        <h3 class="text-xl font-bold text-[#1B2B5A] mb-6">Routine Training Schedule</h3>
                        
                        <div id="schedule-list-container" class="space-y-4"></div>

                        <div id="schedule-empty" class="hidden text-center py-10 text-gray-400 bg-gray-50 rounded-2xl border border-dashed border-gray-200">
                            <p class="text-lg">Belum ada jadwal latihan yang diatur.</p>
                        </div>

                        <div id="raw-schedule-data" class="hidden">{{ community.schedule }}</div>
                        <div id="raw-location-data" class="hidden">{% if community.fitness_spot %}{{ community.fitness_spot.name }}{% else %}Online{% endif %}</div>
                    </div>

                    <div id="tab-members" class="tab-content hidden animate-fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {% for admin in community.admins.all %}
                            <div class="flex items-center justify-between p-4 bg-orange-50 rounded-xl border border-orange-100">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-orange-200 flex items-center justify-center text-orange-700 font-bold">
                                        {{ admin.username|make_list|first|upper }}
                                    </div>
                                    <div>
                                        <p class="font-bold text-gray-800">{{ admin.username }}</p>
                                        <p class="text-xs text-orange-600 font-bold uppercase tracking-wide">Administrator</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% for member in community.members.all %}
                                {% if member not in community.admins.all %}
                                <div class="flex items-center justify-between p-4 bg-white hover:bg-gray-50 rounded-xl border border-gray-100 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-bold border border-gray-200">
                                            {{ member.username|make_list|first|upper }}
                                        </div>
                                        <span class="font-bold text-gray-700">{{ member.username }}</span>
                                    </div>

                                    {% if request.user in community.admins.all %}
                                    <button onclick="openPromoteModal('{{ member.username }}')" title="Promote to Admin" class="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                                    </button>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<div id="promote-modal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-2xl p-6 w-96 shadow-2xl transform scale-95 transition-transform duration-300">
        <div class="flex flex-col items-center text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <h3 class="text-xl font-bold text-[#1B2B5A] mb-2">Promote Member?</h3>
            <p class="text-gray-600 mb-6 text-sm">
                Are you sure you want to promote <br>
                <span id="promote-target-name" class="font-bold text-[#0E5A64] text-lg"></span> <br>
                to be an Administrator?
            </p>
            <div class="flex gap-3 w-full">
                <button onclick="closePromoteModal()" class="flex-1 py-2.5 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button id="confirm-promote-btn" class="flex-1 py-2.5 rounded-xl bg-[#0E5A64] text-white font-bold hover:bg-[#0b464e] shadow-md transition-colors">
                    Yes, Promote
                </button>
            </div>
        </div>
    </div>
</div>
<div id="toast" class="hidden fixed bottom-6 right-6 z-[1000] bg-[#0E5A64] text-white px-6 py-4 rounded-xl shadow-2xl transform transition-all duration-300 translate-y-10 opacity-0 flex items-center gap-3 font-bold">
    <span id="toast-msg">Notification</span>
</div>

{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    :root{ --bg-1: #EAF2FF; --bg-2: #BFD6F2; --nav-text: #FFFFFF; }
    body.home-theme {
        background: radial-gradient(1200px 600px at 15% 6%, rgba(255,255,255,.6), transparent 70%), linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
        min-height: 100vh; color: #1B2B5A;
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    // --- Variabel Global untuk Modal ---
    let targetUserToPromote = null;
    const modalEl = document.getElementById('promote-modal');
    const confirmBtn = document.getElementById('confirm-promote-btn');

    function switchTab(name) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('text-[#0E5A64]', 'border-[#0E5A64]', 'active');
            el.classList.add('text-gray-400', 'border-transparent');
        });
        document.getElementById('tab-' + name).classList.remove('hidden');
        const btn = document.getElementById('btn-' + name);
        btn.classList.remove('text-gray-400', 'border-transparent');
        btn.classList.add('text-[#0E5A64]', 'border-[#0E5A64]', 'active');
    }

    document.addEventListener("DOMContentLoaded", function() {
        const rawSchedule = document.getElementById('raw-schedule-data').innerText;
        const locationName = document.getElementById('raw-location-data').innerText;
        const container = document.getElementById('schedule-list-container');
        const emptyState = document.getElementById('schedule-empty');

        if (!rawSchedule.trim()) {
            emptyState.classList.remove('hidden');
            return;
        }

        const lines = rawSchedule.split('\n');
        
        lines.forEach(line => {
            if (line.trim() === "") return;

            let timePart = "Jadwal";
            let titlePart = line;

            if (line.includes(' - ')) { 
                const separatorIndex = line.indexOf(' - '); 
                timePart = line.substring(0, separatorIndex).trim(); 
                titlePart = line.substring(separatorIndex + 3).trim(); 
            } else if (line.includes('-')) { 
                const parts = line.split('-');
                if (isNaN(parts[0].trim())) { 
                    timePart = parts[0].trim();
                    titlePart = parts.slice(1).join('-').trim();
                }
            }

            const cardHtml = `
                <div class="bg-white border border-[#C8DDF6] rounded-2xl p-4 flex gap-5 items-center hover:shadow-md transition-shadow">
                    <div class="bg-[#E0F2F1] text-[#00695C] font-bold py-3 px-4 rounded-xl text-center min-w-[110px] flex flex-col justify-center border border-[#B2DFDB]">
                        <span class="text-sm uppercase tracking-wide leading-tight">${timePart.replace(' ', '<br>')}</span>
                    </div>
                    <div class="flex-grow">
                        <h4 class="text-lg font-bold text-[#1B2B5A] mb-1">${titlePart}</h4>
                        <div class="flex items-center gap-1.5 text-sm text-[#6B7A99] font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            ${locationName}
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHtml);
        });
    });

    const joinBtn = document.getElementById('join-btn');
    const leaveBtn = document.getElementById('leave-btn');
    const wrapper = document.querySelector('[data-community-id]');

    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        t.classList.remove('hidden', 'translate-y-10', 'opacity-0');
        setTimeout(() => { t.classList.add('translate-y-10', 'opacity-0'); setTimeout(() => t.classList.add('hidden'), 300); }, 3000);
    }

    function handleAction(type) {
        if(!wrapper) return;
        const id = wrapper.dataset.communityId;
        const url = `/community/ajax/${type}/${id}/`;
        
        fetch(url, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.json())
        .then(d => {
            if(d.success) {
                if(type === 'join') { joinBtn.classList.add('hidden'); leaveBtn.classList.remove('hidden'); showToast('Successfully joined!'); } 
                else { leaveBtn.classList.add('hidden'); joinBtn.classList.remove('hidden'); showToast('Successfully left!'); }
                setTimeout(() => location.reload(), 1000);
            } else { alert(d.error); }
        });
    }

    function openPromoteModal(username) {
        targetUserToPromote = username;
        document.getElementById('promote-target-name').innerText = username;
        
        modalEl.classList.remove('hidden');
        setTimeout(() => {
            modalEl.classList.remove('opacity-0');
            modalEl.children[0].classList.remove('scale-95');
            modalEl.children[0].classList.add('scale-100');
        }, 10);
    }

    function closePromoteModal() {
        targetUserToPromote = null;
        modalEl.classList.add('opacity-0');
        modalEl.children[0].classList.remove('scale-100');
        modalEl.children[0].classList.add('scale-95');
        
        setTimeout(() => {
            modalEl.classList.add('hidden');
        }, 300); 
    }

    confirmBtn.onclick = function() {
        if(!targetUserToPromote || !wrapper) return;

        const id = wrapper.dataset.communityId;
        const url = `/community/ajax/add_admin/${id}/`;
        const formData = new FormData();
        formData.append('username', targetUserToPromote);

        const originalText = confirmBtn.innerText;
        confirmBtn.innerText = "Processing...";
        confirmBtn.disabled = true;

        fetch(url, { 
            method: 'POST', 
            headers: { 'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(r => r.json())
        .then(d => {
            closePromoteModal();
            
            confirmBtn.innerText = originalText;
            confirmBtn.disabled = false;

            if(d.success) {
                showToast(`Success! ${targetUserToPromote} is now Admin.`);
                setTimeout(() => location.reload(), 1500);
            } else {
                alert(d.error || "Failed.");
            }
        })
        .catch(err => {
            closePromoteModal();
            confirmBtn.innerText = originalText;
            confirmBtn.disabled = false;
            console.error(err);
        });
    };

    if(joinBtn) joinBtn.onclick = () => handleAction('join');
    if(leaveBtn) leaveBtn.onclick = () => handleAction('leave');
</script>
{% endblock %}
