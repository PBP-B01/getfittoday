{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto py-10">
  <h1 class="text-3xl font-bold mb-6 text-center">Kelola Komunitas</h1>

  <div class="mb-6 bg-gray-100 p-4 rounded-lg">
    <h2 class="font-semibold mb-2">Tambah Komunitas Baru</h2>
    <form id="add-community-form">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Tambah</button>
    </form>
  </div>

  <div id="community-list" class="space-y-2">
    {% for c in communities %}
    <div class="p-3 border rounded flex justify-between items-center" data-id="{{ c.id }}">
      <div>
        <strong>{{ c.name }}</strong> - {{ c.description }}
      </div>
      <div class="space-x-2">
        <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded">Edit</button>
        <button class="delete-btn bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">Hapus</button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const addForm = document.getElementById('add-community-form');
  const listDiv = document.getElementById('community-list');

  addForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const data = new FormData(addForm);
    fetch("{% url 'ajax_add_community' %}", {
      method: "POST",
      body: data,
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    }).then(res => res.json())
      .then(json => {
        if(json.success){
          const div = document.createElement('div');
          div.className = "p-3 border rounded flex justify-between items-center";
          div.setAttribute('data-id', json.id);
          div.innerHTML = `
            <div><strong>${json.name}</strong> - ${json.description}</div>
            <div class="space-x-2">
              <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded">Edit</button>
              <button class="delete-btn bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">Hapus</button>
            </div>
          `;
          listDiv.appendChild(div);
          addForm.reset();
        } else {
          alert("Gagal menambah komunitas");
        }
      });
  });

  listDiv.addEventListener('click', (e) => {
    const target = e.target;
    const parent = target.closest('[data-id]');
    const id = parent.dataset.id;

    if(target.classList.contains('delete-btn')){
      if(confirm("Yakin ingin menghapus komunitas ini?")){
        fetch(`/community/ajax/delete/${id}/`, {
          method: "POST",
          headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}'}
        }).then(res=>res.json()).then(json=>{
          if(json.success){
            parent.remove();
          } else { alert("Gagal menghapus"); }
        });
      }
    }

    if(target.classList.contains('edit-btn')){
      const newName = prompt("Nama baru:", parent.querySelector('strong').innerText);
      const newDesc = prompt("Deskripsi baru:", parent.querySelector('div').innerText.replace(parent.querySelector('strong').innerText+" - ",""));
      if(newName && newDesc){
        const formData = new FormData();
        formData.append('name', newName);
        formData.append('description', newDesc);
        fetch(`/community/ajax/edit/${id}/`, {
          method: "POST",
          body: formData,
          headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}'}
        }).then(res=>res.json()).then(json=>{
          if(json.success){
            parent.querySelector('strong').innerText = json.name;
            parent.querySelector('div').innerHTML = `<strong>${json.name}</strong> - ${json.description}`;
          } else { alert("Gagal edit"); }
        });
      }
    }
  });
});
</script>
{% endblock %}
