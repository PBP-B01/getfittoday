{% extends 'base.html' %}
{% load static %}
{% block title %}Daftar Komunitas{% endblock %}

{% block content %}

<div class="bg-gradient-to-b flex items-center justify-center rounded-b-3xl mb-8 py-6">
  <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-5xl font-extrabold text-[var(--title)] tracking-wide drop-shadow-2xl leading-tight">
    COMMUNITY
  </h1>
</div>

<div class="relative h-[40rem] w-full mb-16 z-[1]">
  <img src="{% static 'community/image/community-hero.jpg' %}" alt="Community Banner"
       class="w-full h-full object-cover rounded-b-3xl shadow-lg object-top">
</div>

<div class="max-w-6xl mx-auto px-4">
  {% if request.user.is_authenticated %}
  <div class="mb-6 text-right">
    <button id="add-community-btn" class="btn-accent">‚ûï Tambah Komunitas</button>
  </div>
  {% endif %}

  <div id="community-cards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 card-grid-container">
    {% for community in communities %}
      <div class="community-card community-item cursor-pointer"
           data-id="{{ community.id }}"
           data-spot-id="{{ community.fitness_spot.place_id }}"
           data-url="{% url 'community_detail' community.id %}">
        <h3 class="card-title text-center">{{ community.name }}</h3>

        {% if community.description %}
          <p class="card-text mb-2">{{ community.description }}</p>
        {% endif %}

        <p class="card-subline">üìç {{ community.fitness_spot.name }}</p>

        {% if community.contact_info %}
          <p class="card-text mt-1">üìû {{ community.contact_info }}</p>
        {% endif %}

        {% if request.user in community.admins.all %}
          <div class="abs-actions-right">
            <button class="chip chip-accent edit-btn">Edit</button>
            <button class="chip chip-danger delete-btn">Delete</button>
          </div>
          <div class="abs-actions-left">
            <button class="chip chip-teal add-admin-btn" title="Add Admin">‚ûï</button>
          </div>
          {% endif %}
        </div>
      {% empty %}
        <p class="text-center text-gray-700 col-span-2">Belum ada komunitas yang terdaftar.</p>
      {% endfor %}
    </div>
  </div>
</div>

<div id="community-modal"
     class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none flex items-center justify-center transition-opacity duration-300 z-40">
  <div class="modal-card relative">
    <button id="close-community-modal" class="modal-close">&times;</button>
    <h3 class="section-title mb-3">Komunitas di Lokasi Ini</h3>
    <div id="community-modal-content"></div>
  </div>
</div>

<div id="edit-modal"
     class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none flex items-center justify-center transition-opacity z-50">
  <div class="modal-card relative">
    <button id="close-edit-modal" class="modal-close">&times;</button>
    <h3 class="section-title mb-5" id="edit-modal-title">Edit Komunitas</h3>

    <form id="edit-form">
      {% csrf_token %}
      <input type="hidden" name="community_id" id="edit-id">
      <div class="mb-2">
        <label class="block text-sm font-medium">Nama</label>
        <input type="text" name="name" id="edit-name" class="w-full border px-2 py-1 rounded">
      </div>
      <div class="mb-2">
        <label class="block text-sm font-medium">Deskripsi</label>
        <textarea name="description" id="edit-description" class="w-full border px-2 py-1 rounded"></textarea>
      </div>
      <div class="mb-2">
        <label class="block text-sm font-medium">Kontak</label>
        <input type="text" name="contact_info" id="edit-contact" class="w-full border px-2 py-1 rounded">
      </div>
      <div class="flex justify-end space-x-2">
        <button type="button" id="close-edit-modal" class="px-3 py-1 rounded bg-gray-400 hover:bg-gray-500 text-white">Batal</button>
        <button type="submit" class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white">Simpan</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}


  .chip{
    padding:.25rem .5rem; border-radius:10px; font-size:.8rem; font-weight:700; border:1px solid transparent;
    box-shadow: 0 4px 10px rgba(0,0,0,.08);
  }
  .chip-accent{ background: var(--accent); color:#0B2E55; }
  .chip-accent:hover{ background: var(--accent-dark); }
  .chip-danger{ background:#DC2626; color:#fff; border-color:#B91C1C; }
  .chip-danger:hover{ filter: brightness(1.05); }
  .chip-teal{ background: var(--nav-bg); color:#fff; border-color: var(--nav-bg-darker); }
  .chip-teal:hover{ filter: brightness(1.05); }

  .modal-card{
    background: var(--card-bg);
    border: 1px solid var(--card-brd);
    border-radius: 16px;
    padding: 22px;
    max-width: 560px; width: 100%;
    color: #0B2E55;
    box-shadow: 0 40px 80px rgba(13,43,63,.18), 0 12px 24px rgba(13,43,63,.12), inset 0 1px 0 rgba(255,255,255,.65);
  }
  .modal-close{
    position:absolute; top:10px; right:12px; font-size:24px; line-height:1; color:#6B7A99;
  }
  .modal-close:hover{ color:#0B2E55; }

  .section-title{ color: var(--title); font-weight: 800; font-size: clamp(18px, 2.4vw, 22px); }
  .muted{ color: var(--ink-weak); }

  .auth-label{ display:block; margin-bottom:.35rem; font-size:.9rem; color: #0B2E55; }
  .search-input{
    width:100%; padding:.6rem .75rem; border-radius:12px; background:#F8FBFF; color:#0B2E55;
    border:1px solid var(--card-brd); outline:none;
    box-shadow: 0 0 0 4px var(--tile);
    transition: box-shadow .18s ease, border-color .18s ease;
  }
  .search-input:focus{
    border-color: var(--card-brd-strong);
    box-shadow: 0 0 0 4px var(--ring), 0 10px 22px rgba(13,43,63,.12);
  }

  .suggestion-list{
    position:absolute; left:0; right:0; max-height:18rem; overflow:auto; z-index:9999;
    background:#fff; color:#0B2E55; border:1px solid var(--card-brd);
    border-radius:12px; margin-top:.25rem; box-shadow: 0 16px 36px rgba(13,43,63,.18);
  }
  .suggestion-list li{ padding:.5rem .75rem; cursor:pointer; }
  .suggestion-list li:hover{ background:#F1F6FF; }
  .suggestion-list li.active-suggestion{ background:#DBEAFF; }

  .btn-accent{
    display:inline-flex; align-items:center; justify-content:center;
    padding:.6rem 1rem; border-radius:12px; font-weight:800; color:#0B2E55;
    background: var(--accent); border:1px solid color-mix(in srgb, var(--accent) 90%, #000 0%);
    box-shadow: 0 12px 28px rgba(224,161,6,.25);
    transition: background .15s ease, transform .05s ease;
  }
  .btn-accent:hover{ background: var(--accent-dark); }
  .btn-accent:active{ transform: translateY(1px); }

  .btn-teal{
    display:inline-flex; align-items:center; justify-content:center;
    padding:.6rem 1rem; border-radius:12px; font-weight:700; color:#fff;
    background: var(--nav-bg); border:1px solid var(--nav-bg-darker);
    box-shadow: 0 12px 28px rgba(14,90,100,.25);
    transition: filter .15s ease, transform .05s ease;
  }
  .btn-teal:hover{ filter: brightness(1.05); }
  .btn-teal:active{ transform: translateY(1px); }

  .btn-muted{
    display:inline-flex; align-items:center; justify-content:center;
    padding:.6rem 1rem; border-radius:12px; font-weight:700; color:#fff;
    background:#6B7280; border:1px solid #4B5563; box-shadow: 0 8px 18px rgba(75,85,99,.25);
  }
  .btn-muted:hover{ filter: brightness(1.05); }

  .community-card{ position:relative; padding-top:48px; }
  .abs-actions-right,.abs-actions-left{
    position:absolute; top:10px; display:flex; gap:6px;
    opacity:0; pointer-events:none; transition:opacity .15s, transform .15s;
    transform: translateY(-4px);
  }
  .abs-actions-right{ right:10px; }
  .abs-actions-left{  left:10px;  }
  .community-card:hover .abs-actions-right,
  .community-card:hover .abs-actions-left{
    opacity:1; pointer-events:auto; transform: translateY(0);
  }

  nav.site-nav { position: sticky; top: 0; z-index: 200; }

  .nav-user { position: relative; }

  .community-hero,
  .community-hero .overlay,
  .home-hero .overlay {
    position: relative;
    z-index: 1;
  }

  #userMenu .font-semibold, #mUserMenu .font-semibold {
      color: rgb(0, 0, 0); 
      opacity: 1;
  }

  #userMenu .text-red-600, #mUserMenu .text-red-600 {
      color: red !important;
  }

  text-gray-800
  #userMenu .px-4 .py-2, #mUserMenu .px-4 .py-2 {
      color: red !important;
  }

  #userMenu a.text-red-600:hover, #mUserMenu a.text-red-600:hover {
      background: rgb(255, 255, 255) !important;
      color: rgb(139, 0, 0) !important;
  }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const editModal = document.getElementById('edit-modal');
  const editForm = document.getElementById('edit-form');
  const closeBtn = document.getElementById('close-edit-modal');
  const cardsContainer = document.getElementById('community-cards');
  const addBtn = document.getElementById('add-community-btn');

  closeBtn.addEventListener('click', () => {
    editModal.classList.add('opacity-0', 'pointer-events-none');
  });

  if(addBtn){
    addBtn.addEventListener('click', () => {
      document.getElementById('edit-modal-title').innerText = "Tambah Komunitas";
      editForm.reset();
      document.getElementById('edit-id').value = "";
      editModal.classList.remove('opacity-0', 'pointer-events-none');
    });
  }

  cardsContainer.addEventListener('click', e => {
    const card = e.target.closest('[data-id]');
    if(!card) return;
    const id = card.dataset.id;

    if(e.target.classList.contains('delete-btn')){
      if(confirm("Yakin ingin menghapus komunitas ini?")){
        fetch(`/community/ajax/delete/${id}/`, {
          method:'POST',
          headers:{
            'X-Requested-With':'XMLHttpRequest',
            'X-CSRFToken':'{{ csrf_token }}'
          }
        }).then(res=>res.json()).then(json=>{
          if(json.success) card.remove();
          else alert("Gagal hapus komunitas");
        });
      }
    }

    if(e.target.classList.contains('edit-btn')){
      document.getElementById('edit-modal-title').innerText = "Edit Komunitas";
      document.getElementById('edit-id').value = id;
      document.getElementById('edit-name').value = card.querySelector('h3').innerText;
      document.getElementById('edit-description').value = card.querySelector('p').innerText;
      const contact = card.querySelector('p.text-blue-700')?.innerText.replace('üìû Kontak: ', '') || '';
      document.getElementById('edit-contact').value = contact;
      editModal.classList.remove('opacity-0', 'pointer-events-none');
    }
  });

  editForm.addEventListener('submit', e => {
    e.preventDefault();
    const formData = new FormData(editForm);
    const id = document.getElementById('edit-id').value;
    const url = id ? `/community/ajax/edit/${id}/` : `/community/ajax/add/`;

    fetch(url, {
      method:'POST',
      body: formData,
      headers:{ 'X-Requested-With':'XMLHttpRequest' }
    }).then(res=>res.json()).then(json=>{
      if(json.success){
        if(id){
          const card = cardsContainer.querySelector(`[data-id='${id}']`);
          card.querySelector('h3').innerText = json.name;
          card.querySelector('p').innerText = json.description;
          if(json.contact_info){
            let p = card.querySelector('p.text-blue-700');
            if(!p){
              p = document.createElement('p');
              p.className = "text-sm mt-1 text-blue-700";
              card.appendChild(p);
            }
            p.innerText = "üìû Kontak: "+json.contact_info;
          }
        } else {
          const div = document.createElement('div');
          div.className = "bg-blue-900 text-white rounded-2xl shadow-md transform transition duration-300 hover:-translate-y-2 hover:shadow-xl relative p-5 border border-blue-800";
          div.dataset.id = json.id;
          div.innerHTML = `
            <h3 class="text-xl font-semibold mb-2 text-center">${json.name}</h3>
            <p class="text-gray-100 mb-2">${json.description}</p>
            ${json.contact_info? `<p class="text-sm mt-1 text-blue-100">üìû ${json.contact_info}</p>`: ''}
            <div class="absolute top-3 right-3 flex space-x-2">
              <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded
            }\
            }
            }