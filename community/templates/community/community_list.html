{% extends 'base.html' %}
{% load static %}
{% block title %}Daftar Komunitas{% endblock %}

{% block head %}
  {{ block.super }}
  <style>
    #fitnessSpotList {
      max-height: 18rem; 
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      z-index: 9999 !important; 
      background-color: #ffffff;
      color: #1f2937;
    }
    #fitnessSpotList li:hover {
      background-color: #eff6ff;
    }
    #fitnessSpotList li.active-suggestion {
      background-color: #dbeafe; 
    }
    #edit-modal {
        z-index: 50 !important;
    }
  </style>
{% endblock %}

{% block content %}
<div class="relative h-[40rem] w-full mb-16">
  <img src="{% static 'community/image/community-hero.jpg' %}"
       alt="Community Banner"
       class="w-full h-full object-cover rounded-b-3xl shadow-lg">
  <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
    <h1 class="text-6xl md:text-7xl font-extrabold text-yellow-400 tracking-wide drop-shadow-2xl">
      Community
    </h1>
  </div>
</div>


<div class="max-w-6xl mx-auto px-4">
  {% if request.user.is_authenticated %}
  <div class="mb-6 text-right">
    <button id="add-community-btn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg transition shadow-md">
      ‚ûï Tambah Komunitas
    </button>
  </div>
  {% endif %}

  <div id="community-cards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for community in communities %}
        <div class="bg-yellow-400 text-black rounded-2xl shadow-md transform transition duration-300 hover:-translate-y-2 hover:shadow-xl relative p-5 border border-yellow-800 cursor-pointer flex flex-col"
             data-id="{{ community.id }}"
             data-spot-id="{{ community.fitness_spot.place_id }}" data-url="{% url 'community_detail' community.id %}">

        <h3 class="text-xl font-semibold mb-2 text-center">{{ community.name }}</h3>
        <p class="text-black-100 mb-2">{{ community.description }}</p>
        <p class="text-sm font-medium mb-1">üìç {{ community.fitness_spot.name }}</p>
        {% if community.contact_info %}
          <p class="text-sm">üìû {{ community.contact_info }}</p>
        {% endif %}

        {% if request.user in community.admins.all %}
        <div class="absolute top-3 right-3 flex space-x-2">
          <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 shadow-sm">Edit</button>
          <button class="delete-btn bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 shadow-sm">Delete</button>
        </div>
        <div class="absolute top-3 left-3">
          <button class="add-admin-btn bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 shadow-sm" title="Add Admin">‚ûï</button>
        </div>
        {% endif %}
        </div>
    {% empty %}
      <p class="text-center text-gray-700 col-span-3">Belum ada komunitas yang terdaftar.</p>
    {% endfor %}
  </div>
</div>

<div id="community-modal" class="fixed inset-0 bg-black bg-opacity-50 opacity-0 pointer-events-none flex items-center justify-center transition-opacity duration-300 z-40">
  <div class="bg-white rounded-xl p-6 max-w-md w-full relative text-black">
    <button id="close-community-modal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">&times;</button>
    <h3 class="font-bold text-lg mb-2">Komunitas di Lokasi Ini</h3>
    <div id="community-modal-content"></div>
  </div>
</div>

<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 opacity-0 pointer-events-none flex items-center justify-center transition-opacity z-50"> <div class="bg-blue-900 text-white p-6 rounded-xl max-w-md w-full relative shadow-2xl">
    <button id="close-edit-modal" class="absolute top-3 right-3 text-white hover:text-gray-300 text-2xl leading-none">&times;</button>
    <h3 class="text-xl font-bold mb-5" id="edit-modal-title">Edit Komunitas</h3>

    <form id="edit-form">
      {% csrf_token %}
      <input type="hidden" name="community_id" id="edit-id">

      <div class="mb-4">
        <label for="id_name" class="block text-sm font-medium mb-1">Nama Komunitas</label>
        {{ form.name }} </div>

      <div class="mb-4">
        <label for="id_description" class="block text-sm font-medium mb-1">Deskripsi</label>
        {{ form.description }} </div>

      <div class="mb-4">
        <label for="fitnessSpotSearchInput" class="block text-sm font-medium mb-1">Fitness Spot</label>
        <div class="relative">
          <input id="fitnessSpotSearchInput" type="text" placeholder="Cari lokasi..."
                 autocomplete="off"
                 class="w-full border rounded p-2 text-black bg-gray-50 placeholder-gray-400">
          <ul id="fitnessSpotList"
              class="absolute left-0 right-0 bg-white text-blue-900 rounded-lg shadow-lg mt-1 hidden">
              </ul>
        </div>
        {{ form.fitness_spot }} </div>
      <div class="mb-5">
        <label for="id_contact_info" class="block text-sm font-medium mb-1">Kontak</label>
        {{ form.contact_info }} </div>

      <div class="flex justify-end space-x-3 pt-2">
        <button type="button" id="close-edit-modal-btn" class="px-4 py-2 rounded-lg bg-gray-500 hover:bg-gray-600 text-white transition">
          Batal
        </button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white transition">
          Simpan
        </button>
      </div>
    </form>
  </div>
</div>

{{ all_fitness_spots_data|json_script:"fitness-spots-data" }}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const editModal = document.getElementById('edit-modal');
  const editForm = document.getElementById('edit-form');
  const closeBtn = document.getElementById('close-edit-modal');
  const closeBtnAlt = document.getElementById('close-edit-modal-btn');
  const cardsContainer = document.getElementById('community-cards');
  const addBtn = document.getElementById('add-community-btn');

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrfToken = getCookie('csrftoken');

  const fitnessSpotSearchInput = document.getElementById('fitnessSpotSearchInput');
  const fitnessSpotList = document.getElementById('fitnessSpotList');
  const realFitnessSpotInput = document.getElementById('id_fitness_spot');

  let ALL_SPOTS_DATA = []; 
  const ALL_SPOTS_DATA_EL = document.getElementById('fitness-spots-data');
  if (ALL_SPOTS_DATA_EL) {
      try {
          const rawContent = ALL_SPOTS_DATA_EL.textContent.trim();
          const jsonData = JSON.parse(rawContent);
          if (Array.isArray(jsonData)) {
              ALL_SPOTS_DATA = jsonData;
              console.log(`Successfully loaded ${ALL_SPOTS_DATA.length} fitness spots.`);
          } else { console.error("Parsed fitness spots data is not an array:", jsonData); }
      } catch (e) { console.error("Failed to parse fitness spots JSON:", e); }
  } else { console.error("Fitness spots data script tag (#fitness-spots-data) not found!"); }

  let fitnessSpotActiveIdx = -1;

  function renderFitnessSpotList(items) {
      if (!fitnessSpotList) return;
      const validItems = Array.isArray(items) ? items : [];
      fitnessSpotList.innerHTML = validItems.map((spot, i) => `
          <li class="px-3 py-2 cursor-pointer ${i === fitnessSpotActiveIdx ? 'active-suggestion' : ''}"
              data-id="${spot.place_id}" data-name="${spot.name || ''}">
              ${spot.name || '(No Name)'}
          </li>
      `).join('');
      fitnessSpotList.classList.toggle('hidden', validItems.length === 0);
  }

  function chooseFitnessSpot(li) {
      if (!li || !fitnessSpotSearchInput || !realFitnessSpotInput || !fitnessSpotList) return;
      fitnessSpotSearchInput.value = li.dataset.name || '';
      realFitnessSpotInput.value = li.dataset.id || '';
      fitnessSpotList.classList.add('hidden');
      fitnessSpotActiveIdx = -1;
  }

  const debounce = (fn, ms) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  const onFitnessSpotType = debounce(() => {
      if (!fitnessSpotSearchInput || !Array.isArray(ALL_SPOTS_DATA)) return;
      const query = fitnessSpotSearchInput.value.trim().toLowerCase();
      if (!query) { fitnessSpotActiveIdx = -1; renderFitnessSpotList([]); return; }
      const results = ALL_SPOTS_DATA.filter(spot => spot.name && spot.name.toLowerCase().includes(query)).slice(0, 15);
      fitnessSpotActiveIdx = -1;
      renderFitnessSpotList(results);
  }, 200);

  if (fitnessSpotSearchInput && fitnessSpotList && realFitnessSpotInput) {
      fitnessSpotSearchInput.addEventListener('input', onFitnessSpotType);
      fitnessSpotSearchInput.addEventListener('focus', () => {  onFitnessSpotType(); });
      fitnessSpotList.addEventListener('mousedown', (e) => { const li = e.target.closest('li'); if (li) chooseFitnessSpot(li); });
      fitnessSpotSearchInput.addEventListener('blur', () => { setTimeout(() => { if (!fitnessSpotList.matches(':hover')) { fitnessSpotList.classList.add('hidden'); fitnessSpotActiveIdx = -1; } }, 150); });
      fitnessSpotSearchInput.addEventListener('keydown', (e) => {
          const items = Array.from(fitnessSpotList.querySelectorAll('li')); if (items.length === 0) return; let newIndex = fitnessSpotActiveIdx;
          if (e.key === 'ArrowDown') { e.preventDefault(); newIndex = Math.min(items.length - 1, fitnessSpotActiveIdx + 1); }
          else if (e.key === 'ArrowUp') { e.preventDefault(); newIndex = Math.max(0, fitnessSpotActiveIdx - 1); }
          else if (e.key === 'Enter') {
              e.preventDefault();
              if (fitnessSpotActiveIdx >= 0 && fitnessSpotActiveIdx < items.length) { chooseFitnessSpot(items[fitnessSpotActiveIdx]); }
              else if (items.length > 0) { chooseFitnessSpot(items[0]); } 
              return;
          }
          else if (e.key === 'Escape') { fitnessSpotList.classList.add('hidden'); fitnessSpotActiveIdx = -1; return; }
          if (newIndex !== fitnessSpotActiveIdx) {
              fitnessSpotActiveIdx = newIndex;
              const currentQuery = fitnessSpotSearchInput.value.trim().toLowerCase();
              const currentResults = (Array.isArray(ALL_SPOTS_DATA) ? ALL_SPOTS_DATA : []).filter(spot => spot.name && spot.name.toLowerCase().includes(currentQuery)).slice(0, 15);
              renderFitnessSpotList(currentResults); 
              const highlightedItem = fitnessSpotList.querySelector('li.active-suggestion');
              highlightedItem?.scrollIntoView({ block: 'nearest' });
          }
      });
  } else { console.error("Fitness spot search elements (#fitnessSpotSearchInput, #fitnessSpotList, #id_fitness_spot) not found!"); }

  function closeModal() { if(editModal) editModal.classList.add('opacity-0', 'pointer-events-none'); }
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (closeBtnAlt) closeBtnAlt.addEventListener('click', closeModal);

  if (addBtn) {
    addBtn.addEventListener('click', () => {
      if (!editForm || !fitnessSpotSearchInput || !realFitnessSpotInput || !fitnessSpotList || !editModal) return;
      document.getElementById('edit-modal-title').innerText = "Tambah Komunitas";
      editForm.reset();
      fitnessSpotSearchInput.value = ''; realFitnessSpotInput.value = '';
      fitnessSpotList.classList.add('hidden'); fitnessSpotActiveIdx = -1; 
      document.getElementById('edit-id').value = "";
      editModal.classList.remove('opacity-0', 'pointer-events-none');
    });
  }

  if (cardsContainer) {
      cardsContainer.addEventListener('click', e => {
          const card = e.target.closest('[data-id]'); if (!card) return; const id = card.dataset.id;
          if (e.target.classList.contains('add-admin-btn')) {
               e.stopPropagation();
               const username = prompt("Enter username to add as admin:"); if (!username) return;
               const formData = new FormData(); formData.append('username', username);
               fetch(`/community/ajax/add_admin/${id}/`, { method: 'POST', body: formData, headers: {'X-Requested-With': 'XMLHttpRequest','X-CSRFToken': csrfToken}})
               .then(res => res.json()).then(json => { alert(json.success ? json.message : `Error: ${json.error}`); });
               return;
           }
          if (e.target.classList.contains('delete-btn')) {
               e.stopPropagation();
               if (confirm("Yakin hapus?")) {
                   fetch(`/community/ajax/delete/${id}/`, { method: 'POST', headers: {'X-Requested-With': 'XMLHttpRequest','X-CSRFToken': csrfToken}})
                   .then(res => res.json()).then(json => { if (json.success) card.remove(); else alert(`Error: ${json.error || 'Gagal hapus'}`); });
               } return;
           }
          if (e.target.classList.contains('edit-btn')) {
              e.stopPropagation();
              if (!editForm || !fitnessSpotSearchInput || !realFitnessSpotInput || !editModal || !fitnessSpotList) return;
              document.getElementById('edit-modal-title').innerText = "Edit Komunitas";
              document.getElementById('edit-id').value = id;
              document.getElementById('id_name').value = card.querySelector('h3')?.innerText || '';
              document.getElementById('id_description').value = card.querySelector('p:nth-of-type(1)')?.innerText || '';
              const spotId = card.dataset.spotId || '';
              const spotName = card.querySelector('p:nth-of-type(2)')?.innerText.replace('üìç ', '') || '';
              realFitnessSpotInput.value = spotId;
              fitnessSpotSearchInput.value = spotName;
              fitnessSpotList.classList.add('hidden'); 
              const contactEl = card.querySelector('p:last-of-type'); let contact = ''; if (contactEl && contactEl.innerText.includes('üìû')) { contact = contactEl.innerText.replace('üìû ', ''); }
              const contactInput = document.getElementById('id_contact_info'); if (contactInput) contactInput.value = contact;
              editModal.classList.remove('opacity-0', 'pointer-events-none'); return;
          }
          if (card.dataset.url) { location.href = card.dataset.url; }
      });
  }

  if (editForm) {
      editForm.addEventListener('submit', e => {
          e.preventDefault();
          if (!fitnessSpotSearchInput || !realFitnessSpotInput) { alert("Form error: Fitness spot inputs missing."); return; }
          if (fitnessSpotSearchInput.value && !realFitnessSpotInput.value) { alert('Pilih Fitness Spot yang valid dari daftar.'); return; }
          if (!fitnessSpotSearchInput.value) { realFitnessSpotInput.value = ''; }

          const formData = new FormData(editForm);
          const id = document.getElementById('edit-id')?.value || '';
          const url = id ? `/community/ajax/edit/${id}/` : `/community/ajax/add/`;

          fetch(url, { method:'POST', body: formData, headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken': csrfToken }})
              .then(res => { if (!res.ok) { return res.text().then(text => {throw new Error(`HTTP error! status: ${res.status}, body: ${text}`)}) } return res.json(); }) 
              .then(json => {
                  if (json.success) {
                      if (id) {
                          const card = cardsContainer?.querySelector(`[data-id='${id}']`);
                          if (card) {
                                card.dataset.spotId = json.fitness_spot_id;
                                card.querySelector('h3').innerText = json.name;
                                card.querySelector('p:nth-of-type(1)').innerText = json.description;
                                card.querySelector('p:nth-of-type(2)').innerText = `üìç ${json.fitness_spot_name}`;
                                let contactP = Array.from(card.querySelectorAll('p')).find(p => p.innerText.includes('üìû'));
                                if (json.contact_info) {
                                    if (!contactP) { contactP = document.createElement('p'); contactP.className = "text-sm"; card.querySelector('p:last-of-type').after(contactP); }
                                    contactP.innerText = "üìû " + json.contact_info;
                                } else if (contactP) { contactP.remove(); }
                           }
                      } else {
                          if (!cardsContainer) return;
                          const newCard = document.createElement('div');
                          newCard.className = "bg-yellow-400 text-black rounded-2xl shadow-md transform transition duration-300 hover:-translate-y-2 hover:shadow-xl relative p-5 border border-yellow-800 cursor-pointer flex flex-col";
                          newCard.dataset.id = json.id;
                          newCard.dataset.url = json.detail_url;
                          newCard.dataset.spotId = json.fitness_spot_id;
                          newCard.innerHTML = `
                              <h3 class="text-xl font-semibold mb-2 text-center">${json.name}</h3>
                              <p class="text-black-100 mb-2">${json.description}</p>
                              <p class="text-sm font-medium mb-1">üìç ${json.fitness_spot_name}</p>
                              ${json.contact_info ? `<p class="text-sm">üìû ${json.contact_info}</p>` : ""}
                              <div class="absolute top-3 right-3 flex space-x-2">
                                <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 shadow-sm">Edit</button>
                                <button class="delete-btn bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 shadow-sm">Delete</button>
                              </div>
                              <div class="absolute top-3 left-3">
                                <button class="add-admin-btn bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 shadow-sm" title="Add Admin">‚ûï</button>
                              </div>
                            `;
                          const emptyMsg = cardsContainer.querySelector('p.text-center');
                          if (emptyMsg) emptyMsg.remove();
                          cardsContainer.appendChild(newCard);
                      }
                      closeModal();
                  } else { 
                      if (json.errors) {
                           let errorMsg = "Operasi gagal:\n";
                           for (const field in json.errors) { errorMsg += `\n- ${field}: ${json.errors[field][0].message}`; } 
                      }
                      else { alert(`Operasi gagal: ${json.error || 'Terjadi kesalahan.'}`); }
                  }
              })
              .catch(error => { console.error("Fetch error:", error); alert(`Terjadi error di server: ${error.message}`); }); 
      });
  }
});
</script>
{% endblock %}