{% extends "base.html" %}
{% block title %}My bookings{% endblock %}

{% block content %}
<section class="max-w-4xl mx-auto py-10">
  <h1 class="text-3xl font-bold text-yellow-400 mb-6">My bookings</h1>

  <div class="space-y-3">
    {% for it in items %}
    <div class="flex items-center justify-between bg-white/10 rounded-xl px-4 py-3">
        <div>
        <div class="font-semibold text-white">{{ it.place_name }}</div>
        <div class="text-white/80 text-sm">
            {{ it.start|date:"Y-m-d H:i" }} — {{ it.end|date:"Y-m-d H:i" }}
        </div>
        <div class="mt-1">
            {% if it.status == "pending" %}
            <span class="inline-block text-xs px-2 py-0.5 rounded bg-amber-400 text-blue-900 font-semibold">Pending</span>
            {% elif it.status == "confirmed" %}
            <span class="inline-block text-xs px-2 py-0.5 rounded bg-emerald-500 text-white font-semibold">Confirmed</span>
            {% else %}
            <span class="inline-block text-xs px-2 py-0.5 rounded bg-slate-500 text-white font-semibold">Cancelled</span>
            {% endif %}
        </div>
        </div>

        {% if it.can_cancel %}
        <form method="post" action="{% url 'booking:booking-cancel' it.id %}">
            {% csrf_token %}
            <button class="px-3 py-1 rounded bg-rose-500 hover:bg-rose-600 text-white text-sm">Cancel</button>
        </form>
        {% else %}
        <span class="text-white/50 text-sm">Cannot cancel</span>
        {% endif %}
    </div>
    {% empty %}
    <div class="text-white/70">Belum ada booking.</div>
    {% endfor %}

  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}
const csrftoken = getCookie('csrftoken');

function toast(msg, ok = true) {
  const el = document.getElementById('toast');
  const base =
    "fixed bottom-6 right-6 z-[80] min-w-[240px] max-w-sm rounded-xl px-4 py-3 text-sm " +
    "transition-all duration-300 shadow-[0_8px_30px_rgba(0,0,0,.25)]";
  const kind = ok
    ? "bg-emerald-500 text-white shadow-[0_8px_30px_rgba(16,185,129,.35)]"
    : "bg-rose-500 text-white shadow-[0_8px_30px_rgba(244,63,94,.35)]";

  el.textContent = msg;
  el.className = base + " " + kind + " translate-y-2 opacity-0";
  el.classList.remove("hidden");
  void el.offsetWidth;
  el.classList.remove("translate-y-2","opacity-0");
  clearTimeout(el._t);
  el._t = setTimeout(() => {
    el.classList.add("translate-y-2","opacity-0");
    setTimeout(() => el.classList.add("hidden"), 300);
  }, 2200);
}

document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.cancel-btn');
  if (!btn) return;

  const id = btn.dataset.id;
  btn.disabled = true; const old = btn.textContent; btn.textContent = 'Cancelling…';
  try {
    const r = await fetch(`/booking/cancel/${encodeURIComponent(id)}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      credentials: 'same-origin',
    });
    if (!r.ok) {
      toast(`Gagal cancel [${r.status}]`, false);
      btn.disabled = false; btn.textContent = old;
      return;
    }
    location.reload();
  } catch (err) {
    toast('Gagal cancel (network)', false);
    btn.disabled = false; btn.textContent = old;
  }
});
</script>
{% endblock %}
