{% extends "base.html" %}
{% load static %}
{% block title %}Booking{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Booking Lapangan</h1>

<div class="bg-white/10 rounded-xl p-4 space-y-4">
  <div class="grid md:grid-cols-3 gap-4">
    <div>
      <label class="block text-sm mb-1 text-white/90">Pilih Tempat</label>
      <select id="placeSelect" name="place_id" class="w-full rounded-lg text-blue-900 px-3 py-2">
        <option value="">Pilih tempatâ€¦</option>
        {% for s in spots %}
          <option value="{{ s.place_id }}"
                  data-lat="{{ s.latitude }}" data-lng="{{ s.longitude }}">
            {{ s.name }}
          </option>
        {% empty %}
          <!-- Kalau kosong, kasih info biar ketahuan -->
          <option value="" disabled>(Data tempat tidak tersedia)</option>
        {% endfor %}
      </select>
      <input type="hidden" name="lat" id="placeLat">
      <input type="hidden" name="lng" id="placeLng">
    </div>

    <div>
      <label class="block mb-1 text-sm text-white/80">Tanggal</label>
      <input id="date" type="date" class="w-full text-blue-900 px-3 py-2 rounded" required>
    </div>

    <div class="flex items-end">
      <button id="checkBtn" class="bg-yellow-400 text-blue-900 font-bold px-4 py-2 rounded hover:bg-yellow-300 w-full">
        Cek Ketersediaan
      </button>
    </div>
  </div>

  <div id="slots" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  const resourceEl = document.getElementById('resource');
  const dateEl = document.getElementById('date');
  const checkBtn = document.getElementById('checkBtn');
  const slotsEl = document.getElementById('slots');

  dateEl.value = new Date().toISOString().slice(0,10);
  checkBtn.addEventListener('click', loadSlots);

  async function loadSlots(){
    slotsEl.innerHTML = '';
    const resource = resourceEl.value;
    const date = dateEl.value;
    try {
      const r = await fetch(`/booking/availability/?resource=${encodeURIComponent(resource)}&date=${encodeURIComponent(date)}`);
      if (!r.ok) throw new Error('Gagal ambil data slot');
      const data = await r.json();
      if (!Array.isArray(data) || data.length === 0){
        slotsEl.innerHTML = '<div class="text-white/80">Tidak ada slot kosong.</div>';
        return;
      }
      renderSlots(resource, data);
    } catch(e){
      alert(e.message || 'Error mengambil slot');
    }
  }

  function renderSlots(resourceId, slots){
    slotsEl.innerHTML = '';
    for (const s of slots){
      const start = new Date(s.start);
      const end = new Date(s.end);
      const label = `${pad(start.getHours())}:${pad(start.getMinutes())} - ${pad(end.getHours())}:${pad(end.getMinutes())}`;

      const btn = document.createElement('button');
      btn.className = "w-full text-left bg-white/20 hover:bg-white/30 rounded p-3";
      btn.textContent = label;
      btn.addEventListener('click', () => book(resourceId, start, end));
      slotsEl.appendChild(btn);
    }
  }

  function pad(n){ return String(n).padStart(2,'0'); }

  async function book(resourceId, start, end){
    if (!confirm('Lanjut booking slot ini?')) return;

    try {
      const r = await fetch('/booking/book/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
        },
        credentials: 'same-origin',
        body: JSON.stringify({
          resource_id: resourceId,
          start_time: start.toISOString(),
          end_time: end.toISOString()
        })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data?.detail || 'Gagal booking');
      alert(`Sukses. ID: ${data.id} | Status: ${data.status} | Harga: ${data.price}`);
      loadSlots();
    } catch(e){
      alert(e.message || 'Error saat booking');
    }
  }

  (function () {
    const sel = document.getElementById('placeSelect');
    const latEl = document.getElementById('placeLat');
    const lngEl = document.getElementById('placeLng');

    if (!sel) return;
    sel.addEventListener('change', () => {
      const opt = sel.options[sel.selectedIndex];
      if (!opt) return;
      if (latEl) latEl.value = opt.dataset.lat || '';
      if (lngEl) lngEl.value = opt.dataset.lng || '';
    });

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const toRad = d => d * Math.PI / 180;
        const R = 6371000;
        const dist = (a,b,c,d)=> {
          const dLat = toRad(c-a), dLng = toRad(d-b);
          const s1 = Math.sin(dLat/2)**2;
          const s2 = Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLng/2)**2;
          return 2*R*Math.asin(Math.sqrt(s1+s2));
        };
        const userLat = pos.coords.latitude, userLng = pos.coords.longitude;
        const opts = Array.from(sel.querySelectorAll('option')).filter(o => o.value);
        opts.sort((oa, ob) => dist(userLat, userLng, +oa.dataset.lat, +oa.dataset.lng) -
                               dist(userLat, userLng, +ob.dataset.lat, +ob.dataset.lng));
        const ph = sel.querySelector('option[value=""]');
        sel.innerHTML = '';
        if (ph) sel.appendChild(ph);
        opts.forEach(o => sel.appendChild(o));
      });
    }
  })();

  const sel = document.getElementById('placeSelect');
  const latEl = document.getElementById('placeLat');
  const lngEl = document.getElementById('placeLng');
  if (sel) {
    sel.addEventListener('change', () => {
      const opt = sel.options[sel.selectedIndex];
      if (!opt) return;
      if (latEl) latEl.value = opt.dataset.lat || '';
      if (lngEl) lngEl.value = opt.dataset.lng || '';
    });
  }
</script>
{% endblock %}