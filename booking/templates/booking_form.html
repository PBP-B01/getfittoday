{% extends "base.html" %}
{% load static %}
{% block title %}Booking{% endblock %}

{% block content %}
<section class="max-w-5xl mx-auto py-8">
  <h1 class="text-3xl font-bold text-yellow-400 mb-6 text-center">Book Location</h1>
  <!-- Search box -->
  <div class="flex justify-center mb-6">
    <div class="w-full md:w-2/3">
      <label class="block text-sm mb-2 text-white/90">Choose Location</label>
      <div class="relative">
        <input id="spotCombo" type="text" placeholder="Search location.,."
               autocomplete="off"
               class="w-full rounded-lg text-blue-900 px-3 py-2 placeholder:text-blue-800/70">
        <ul id="spotList"
            class="absolute left-0 right-0 bg-white text-blue-900 rounded-lg shadow-2xl mt-1
                   max-h-72 overflow-auto hidden z-[70]"></ul>
      </div>
      <input type="hidden" name="place_id" id="placeId">
      <input type="hidden" name="lat"      id="placeLat">
      <input type="hidden" name="lng"      id="placeLng">
      {{ spots|json_script:"spots-json" }}
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Kalender besar -->
    <div class="lg:col-span-2 bg-white/10 rounded-xl p-4">
      <div class="flex items-center justify-between mb-4">
        <button id="prevMonth" class="px-3 py-1 rounded bg-white/20 hover:bg-white/30">‹</button>
        <h2 id="calTitle" class="font-semibold text-lg"></h2>
        <button id="nextMonth" class="px-3 py-1 rounded bg-white/20 hover:bg-white/30">›</button>
      </div>

      <div class="grid grid-cols-7 gap-2 text-center text-white/80 text-sm mb-2">
        <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
      </div>
      <div id="calGrid" class="grid grid-cols-7 gap-2"></div>

      <p id="calHint" class="mt-4 text-white/70 text-sm">
        Pick a location, then choose a date to check available hours.
      </p>
    </div>

    <!-- Slot ketersediaan -->
    <div class="bg-white/10 rounded-xl p-4">
      <h3 class="font-semibold mb-3">Available hours</h3>
      <div id="slots" class="space-y-2 text-sm"></div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}
const csrftoken = getCookie('csrftoken');

// DOM
const placeIdEl = document.getElementById('placeId');
const slotsEl = document.getElementById('slots');
const calTitle = document.getElementById('calTitle');
const calGrid = document.getElementById('calGrid');
const prevBtn = document.getElementById('prevMonth');
const nextBtn = document.getElementById('nextMonth');
const calHint = document.getElementById('calHint');

const SPOTS = (JSON.parse(document.getElementById('spots-json')?.textContent || '[]') || [])
  .map(s => ({
    id: s.place_id,
    name: s.name || '(Tanpa nama)',
    lat: parseFloat(s.latitude),
    lng: parseFloat(s.longitude),
    dist: Infinity
  }));

(function () {
  const input  = document.getElementById('spotCombo');
  const listEl = document.getElementById('spotList');
  const latEl  = document.getElementById('placeLat');
  const lngEl  = document.getElementById('placeLng');

  function distKm(aLat, aLng, bLat, bLng) {
    const toRad = d => d * Math.PI/180, R = 6371;
    const dLat = toRad(bLat - aLat), dLng = toRad(bLng - aLng);
    const la1 = toRad(aLat), la2 = toRad(bLat);
    const h = Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLng/2)**2;
    return 2*R*Math.asin(Math.sqrt(h));
  }

  function nearestN(n) {
    const anyDist = SPOTS.some(s => Number.isFinite(s.dist) && s.dist !== Infinity);
    const arr = SPOTS.slice().sort((a,b) => {
      if (anyDist) return (a.dist ?? Infinity) - (b.dist ?? Infinity);
      return a.name.localeCompare(b.name);
    });
    return arr.slice(0, n);
  }

  let activeIdx = -1;
  function render(items) {
    listEl.innerHTML = items.map((s, i) => `
      <li class="px-3 py-2 cursor-pointer hover:bg-blue-50 ${i===activeIdx?'bg-blue-100':''}"
          data-id="${s.id}" data-lat="${s.lat}" data-lng="${s.lng}" data-name="${s.name}">
        ${s.name} ${Number.isFinite(s.dist) ? `<span class="text-xs text-gray-500"> • ${s.dist.toFixed(1)} km</span>` : ''}
      </li>
    `).join('');
    listEl.classList.toggle('hidden', items.length === 0);
  }

  function choose(li) {
    if (!li) return;
    input.value = li.dataset.name || '';
    placeIdEl.value  = li.dataset.id   || '';
    latEl.value = li.dataset.lat  || '';
    lngEl.value = li.dataset.lng  || '';
    listEl.classList.add('hidden');
    slotsEl.innerHTML = '';
    calHint.textContent = placeIdEl.value
      ? 'Click a date to show available hours'
      : 'Pick a location, then choose a date to check available hours.';
  }

  // Geosort top 15
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      SPOTS.forEach(s => {
        if (Number.isFinite(s.lat) && Number.isFinite(s.lng)) {
          s.dist = distKm(latitude, longitude, s.lat, s.lng);
        }
      });
      if (!input.value.trim()) render(nearestN(15));
    }, () => { if (!input.value.trim()) render(nearestN(15)); }, { timeout: 5000 });
  } else {
    render(nearestN(15));
  }

  const deb = (fn, ms) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
  const onType = deb(() => {
    const q = input.value.trim().toLowerCase();
    if (q.length < 2) { activeIdx = -1; render(nearestN(15)); return; }
    const out = SPOTS.filter(s => s.name.toLowerCase().includes(q)).slice(0, 200);
    activeIdx = -1; render(out);
  }, 100);

  input.addEventListener('input', onType);
  input.addEventListener('focus', () => { if (!input.value.trim()) render(nearestN(15)); });

  listEl.addEventListener('mousedown', (e) => {
    const li = e.target.closest('li'); if (li) choose(li);
  });
  input.addEventListener('blur', () => setTimeout(()=>listEl.classList.add('hidden'), 150));

  input.addEventListener('keydown', (e) => {
    const items = Array.from(listEl.querySelectorAll('li'));
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIdx = Math.min(items.length-1, activeIdx+1);
      render(items.map(li => ({ id: li.dataset.id, name: li.dataset.name, lat: +li.dataset.lat, lng: +li.dataset.lng })));
      listEl.querySelectorAll('li')[activeIdx]?.scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIdx = Math.max(0, activeIdx-1);
      render(items.map(li => ({ id: li.dataset.id, name: li.dataset.name, lat: +li.dataset.lat, lng: +li.dataset.lng })));
      listEl.querySelectorAll('li')[activeIdx]?.scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'Enter') {
      if (!listEl.classList.contains('hidden')) {
        e.preventDefault(); choose(listEl.querySelectorAll('li')[activeIdx] || listEl.querySelector('li'));
      }
    } else if (e.key === 'Escape') {
      listEl.classList.add('hidden');
    }
  });
})();

// Kalender
let view = new Date();
view.setDate(1);

function fmtDateISO(d){ return d.toISOString().slice(0,10); }
function pad(n){ return String(n).padStart(2,'0'); }

function renderCalendar() {
  const y = view.getFullYear();
  const m = view.getMonth();

  const bulan = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  calTitle.textContent = `${bulan[m]} ${y}`;

  calGrid.innerHTML = '';
  const firstDay = new Date(y, m, 1);
  const startIdx = firstDay.getDay();
  let d = new Date(y, m, 1 - startIdx);

  for (let i = 0; i < 42; i++) {
    const cell = document.createElement('button');
    cell.type = 'button';
    const isCurrentMonth = d.getMonth() === m;

    cell.className =
      'aspect-square w-full rounded-lg px-1 text-left ' +
      (isCurrentMonth ? 'bg-white/10 hover:bg-white/20' : 'bg-white/5 text-white/50');

    cell.dataset.date = fmtDateISO(d);
    cell.innerHTML = `<div class="text-xs text-right">${d.getDate()}</div>`;

    if (isCurrentMonth) {
      cell.addEventListener('click', async () => {
        if (!placeIdEl.value) { alert('Pilih tempat dulu.'); return; }
        await loadSlots(placeIdEl.value, cell.dataset.date);
        Array.from(calGrid.children).forEach(n => n.classList.remove('ring-2','ring-yellow-300'));
        cell.classList.add('ring-2','ring-yellow-300');
      });
    } else {
      cell.disabled = true;
    }

    calGrid.appendChild(cell);
    d.setDate(d.getDate() + 1);
  }
}

prevBtn.addEventListener('click', () => { view.setMonth(view.getMonth() - 1); renderCalendar(); });
nextBtn.addEventListener('click', () => { view.setMonth(view.getMonth() + 1); renderCalendar(); });

async function loadSlots(placeId, dateISO){
  slotsEl.innerHTML = '<div class="text-white/80">Memuat…</div>';
  const r = await fetch(`/booking/availability/?resource=${encodeURIComponent(placeId)}&date=${encodeURIComponent(dateISO)}`);
  if (!r.ok) { slotsEl.innerHTML = '<div class="text-red-300">Gagal memuat slot.</div>'; return; }
  const data = await r.json();

  if (!Array.isArray(data) || data.length === 0) {
    slotsEl.innerHTML = `<div class="text-white/70">Tidak ada slot untuk ${dateISO}.</div>`;
    return;
  }

  slotsEl.innerHTML = '';
  data.forEach(s => {
    const start = new Date(s.start);
    const end   = new Date(s.end);
    const label = `${pad(start.getHours())}:${pad(start.getMinutes())} — ${pad(end.getHours())}:${pad(end.getMinutes())}`;

    const row = document.createElement('div');
    row.className = "flex items-center justify-between bg-white/15 rounded-lg px-3 py-2";
    row.innerHTML = `
      <div>${label}</div>
      <button class="text-blue-900 bg-yellow-400 hover:bg-yellow-300 px-3 py-1 rounded">Pilih</button>
    `;
    row.querySelector('button').addEventListener('click', async () => {
      const resp = await fetch('/booking/book/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        credentials: 'same-origin',
        body: JSON.stringify({
          resource_id: placeId,
          start_time: start.toISOString(),
          end_time:   end.toISOString()
        })
      });
      if (resp.ok) alert(`Kamu memilih ${label} di ${dateISO}`);
      else alert('Gagal booking.');
    });

    slotsEl.appendChild(row);
  });
}

renderCalendar();
</script>
{% endblock %}
