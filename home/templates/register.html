{% extends "base.html" %}
{% load static %}

{% block title %}Register{% endblock %}

{% block content %}
<section class="max-w-md mx-auto mt-10 bg-white/10 p-6 rounded-xl">
  <h1 class="text-2xl font-bold mb-4 text-yellow-400">Register</h1>

  <form id="regForm" class="space-y-4">
    {% csrf_token %}
    <div>
      <label class="block text-sm mb-1 text-white/90">Username</label>
      <input name="username" class="w-full px-3 py-2 rounded text-blue-900" required>
    </div>
    <div>
      <label class="block text-sm mb-1 text-white/90">Password</label>
      <input type="password" name="password1" class="w-full px-3 py-2 rounded text-blue-900" required>
    </div>
    <div>
      <label class="block text-sm mb-1 text-white/90">Confirm Password</label>
      <input type="password" name="password2" class="w-full px-3 py-2 rounded text-blue-900" required>
    </div>

    <div id="regErrors" class="text-red-300 text-sm"></div>

    <button id="regBtn"
            class="w-full bg-yellow-400 hover:bg-yellow-300 text-blue-900 font-bold py-2 rounded">
      Register
    </button>
  </form>

  <p class="mt-4 text-white/80 text-sm">
    Already have an account? <a href="{% url 'home:login' %}" class="text-yellow-300 underline">Login</a>
  </p>
</section>
{% endblock %}

{% block extra_js %}
<script>
  function getCookie(n){
    const m = document.cookie.match('(^|;)\\s*'+n+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  const form = document.getElementById('regForm');
  const out  = document.getElementById('regErrors');
  const btn  = document.getElementById('regBtn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    out.textContent = '';
    btn.disabled = true;

    const fd = new FormData(form);
    try {
      const r = await fetch("{% url 'home:register_ajax' %}", {
        method: "POST",
        headers: {"X-CSRFToken": getCookie('csrftoken')},
        body: fd,
        credentials: "same-origin",
      });

      const data = await r.json();
      if (!r.ok || !data.ok) {
        if (data.errors) {
          out.innerHTML = Object.entries(data.errors)
            .map(([field, msgs]) => `<div>${field}: ${(Array.isArray(msgs)?msgs.join(', '):msgs)}</div>`)
            .join('');
        } else {
          out.textContent = "Registrasi gagal.";
        }
        btn.disabled = false;
        return;
      }
      window.location.href = data.redirect || "{% url 'home:login' %}";
    } catch (err) {
      out.textContent = "Terjadi kesalahan jaringan. Cobalah lagi.";
      btn.disabled = false;
    }
  });
</script>
{% endblock %}
